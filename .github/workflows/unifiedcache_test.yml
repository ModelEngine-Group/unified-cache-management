name: 'test'

on:
  push:
    branches:
      - 'main'
      - 'dev*'
      - '*release'
  pull_request:
    branches:
      - 'main'
      - 'dev*'
      - '*release'

jobs:
  call-lint:
    uses: ./.github/workflows/pre-commit.yml

  unit-test:
    needs: call-lint
    name: Run Unittests
    runs-on: ubuntu-latest
    container:
      image: vllm/vllm-openai:v0.9.2
      env:
        VLLM_USE_PRECOMPILED: 1
        PLATFORM: cuda
    steps:
      - name: Install system deps
        run: |
          apt-get update -y
          apt-get install -y python3-pip git build-essential

      - name: Clone vLLM
        run: |
          git clone --depth 1 --branch v0.9.2 \
            https://github.com/vllm-project/vllm.git \
            /vllm-workspace/vllm
      
      - name: Install vLLM (CPU)
        working-directory: /vllm-workspace/vllm
        run: |
          pip uninstall -y vllm
          VLLM_TARGET_DEVICE=empty \
          pip install -v -e . \
            --extra-index-url https://download.pytorch.org/whl/cpu/
      
      - name: Checkout unified-cache-management repo
        uses: actions/checkout@v4
        
      - name: Print debug info
        run: |
          echo "GITHUB_WORKSPACE is $GITHUB_WORKSPACE"
          ls -l $GITHUB_WORKSPACE/ucm/patch

      - name: Debug repo layout
        run: |
          echo "GITHUB_WORKSPACE=$GITHUB_WORKSPACE"
          find "$GITHUB_WORKSPACE" -type f -name "*.patch"
          ls -l "$GITHUB_WORKSPACE"
      - name: Apply patch
        run: |
          git -C /vllm-workspace/vllm apply $GITHUB_WORKSPACE/ucm/patch/0.9.2/vllm-adapt.patch
      

      - name: Install unified-cache-management
        run: pip install -v -e . --no-build-isolation

      - name: Run ut
        run: python3 -m unittest discover -s test

