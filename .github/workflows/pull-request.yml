name: 'Pull Request Gate'

on:
  pull_request:
    branches: [ "dev*", "main", "*release", "feature*" ]

jobs:
  # protect the workflows dir, only allow specific users to modify
  protect-workflows-dir:
    runs-on: ubuntu-latest
    outputs:
      allowed: ${{ steps.check.outputs.allowed }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - id: check
        env:
          ACTOR: ${{ github.actor }}
        run: |
          # get the target branch contents
          git fetch origin ${{ github.base_ref }}

          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          echo "CHANGED_FILES=$CHANGED_FILES"

          if ! echo "$CHANGED_FILES" | grep -q '^\.github/workflows/'; then
            echo "No .github/workflows changes, allow."
            echo "allowed=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          ALLOWED_USERS=("dante159753" "mag1c-h")
          
          echo ".github changes detected, check if user is allowed..."
          ACTOR="${{ github.actor }}"
          echo "PR author: $ACTOR"

          for u in "${ALLOWED_USERS[@]}"; do
            if [[ "$ACTOR" == "$u" ]]; then
              echo "Authorized user, allowing change."
              echo "allowed=true" >> $GITHUB_OUTPUT
              exit 0
            fi
          done

          echo "ERROR: Only privileged users may modify .github/workflows/"
          echo "allowed=false" >> $GITHUB_OUTPUT
          exit 1

  lint-and-unit-tests:
    needs: protect-workflows-dir
    if: needs.protect-workflows-dir.outputs.allowed == 'true'
    uses: ./.github/workflows/lint-and-test.yml

  test-e2e-pc-gpu:
    runs-on: gpu
    needs: lint-and-unit-tests
    env:
      BUILD_TYPE: Release
    permissions:
      checks: write
      pull-requests: write
    steps:
    - name: Clean repo
      run: |
        if [ -d "${{github.workspace}}" ]; then
          cd ${{github.workspace}}
          rm -rf ./*
          rm -rf .[!.]*
        fi
    - uses: actions/checkout@v4
    - name: Build
      run: |
        cd ${{github.workspace}}
        export PLATFORM=cuda
        pip install -v -e . --no-build-isolation
    - name: Test E2E
      run: |
        cd ${{github.workspace}}
        cd test
        pip install pytest pytest-cov pynvml pandas
        python3 -m pytest --stage=1 --feature=offline_inference --junitxml=offline-inference.xml
    - name: Upload pytest results
      uses: EnricoMi/publish-unit-test-result-action/linux@v2
      if: (!cancelled())
      with:
        files: |
          ${{github.workspace}}/test/offline-inference.xml
        check_name: Prefix cache test results

  test-e2e-sparse-gpu:
    runs-on: gpu
    needs: lint-and-unit-tests
    env:
      BUILD_TYPE: Release
    permissions:
      checks: write
      pull-requests: write
    steps:
    - name: Clean repo
      run: |
        if [ -d "${{github.workspace}}" ]; then
          cd ${{github.workspace}}
          rm -rf ./*
          rm -rf .[!.]*
        fi
    - uses: actions/checkout@v4
    - name: Build
      run: |
        cd ${{github.workspace}}
        export PLATFORM=cuda
        export ENABLE_SPARSE=TRUE
        pip install -v -e . --no-build-isolation
    - name: Test E2E
      run: |
        cd ${{github.workspace}}
        cd test
        pip install pytest pytest-cov pynvml pandas
        python3 -m pytest --stage=1 --feature=offline_inference_sparse --junitxml=offline-inference-sparse.xml
    - name: Upload pytest results
      uses: EnricoMi/publish-unit-test-result-action/linux@v2
      if: (!cancelled())
      with:
        files: |
          ${{github.workspace}}/test/offline-inference-sparse.xml
        check_name: Sparse attention test results

