import contextlib
import json
import os
import time
from dataclasses import asdict

from transformers import AutoTokenizer

# Third Party
from vllm import LLM, SamplingParams
from vllm.config import KVTransferConfig
from vllm.engine.arg_utils import EngineArgs

from ucm.logger import init_logger

MODEL_PATH = "/home/models/Qwen2.5-14B-Instruct"
tokenizer = AutoTokenizer.from_pretrained(MODEL_PATH)
logger = init_logger(__name__)


def setup_environment_variables():
    os.environ["VLLM_USE_V1"] = "1"
    os.environ["PYTHONHASHSEED"] = "123456"
    os.environ["VLLM_TORCH_PROFILER_DIR"] = "./vllm_profile"

@contextlib.contextmanager
def build_llm_with_uc(module_path: str, name: str, model: str):
    ktc = KVTransferConfig(
        kv_connector=name,
        kv_connector_module_path=module_path,
        kv_role="kv_both",
        kv_connector_extra_config={
            "ucm_connector_name": "UcmNfsStore",
            "ucm_connector_config": {
                "storage_backends": "/tmp/kvstar_nfs",
                "kv_block_size": 33554432,
            },
            "ucm_sparse_config": {
                "KVStarMultiStep": {
                    "init_window_sz": 1,
                    "local_window_sz": 2,
                    "sparse_ratio": 0.25,
                    "retrieval_stride": 8,
                    "blk_repre_dim_prune_ratio": 0.25, # 块表征维度裁剪
                    "blk_repre_inner_token_merge": 2 # 块内几个token融合成一个表征
                }
            },
        },
    )

    llm_args = EngineArgs(
        model=model,
        kv_transfer_config=ktc,
        # kv_transfer_config=None,
        max_model_len=65536,
        gpu_memory_utilization=0.85,
        max_num_batched_tokens=30000,
        # enforce_eager=True,  # eager和非eager
        tensor_parallel_size=2,
        # enable_prefix_caching=False,
        # block_size=32
    )

    llm = LLM(**asdict(llm_args))
    try:
        yield llm
    finally:
        logger.info("LLM engine is exiting.")


def print_output(
    llm: LLM,
    prompt: list[str],
    sampling_params: SamplingParams,
    req_str: str,
):
    start = time.time()
    # llm.start_profile()
    outputs = llm.generate(prompt, sampling_params)
    # llm.stop_profile()
    end = time.time()
    print("-" * 50)
    for output in outputs:
        generated_text = output.outputs[0].text
        print(f"Generated text: {generated_text!r}")
    print(f"Generation took {end - start:.2f} seconds, {req_str} request done.")
    print("-" * 50)


def main():
    module_path = "ucm.integration.vllm.uc_connector"
    name = "UnifiedCacheConnectorV1"
    model = os.getenv("MODEL_PATH", "/home/models/Qwen2.5-14B-Instruct")

    # setup_environment_variables()

    with build_llm_with_uc(module_path, name, model) as llm:
        prompts_prefill_more_than_2_full_blk = [
            "《世界之墓的低语》凯伦是最后的档案保管员。他的国度是一个直径三十公里的金属球体，名为“最终档案库”，深埋于一颗被遗忘的星球的地幔之下。"
            "地表之上，世界正在死去，被一种名为“时序晶体”的缓慢灾变所吞噬。"
            "紫罗兰色的光芒是这个世界上唯一剩下的颜色，那是晶化的大气折射着一颗垂死恒星的光所形成的诡异暮色。"
            "他的每一天都在精确的重复中展开。早晨七点，营养膏自动从食物分配器中挤出，味道永远是中性的，像是吞咽温暖的黏土。"
            "七点十五分，他开始对档案库的核心系统进行巡检。数以万亿计的灵魂——或者说，他们生命的数字印记——沉睡在冰冷的服务器矩阵中，每一个矩阵都像是一座黑色的墓碑。"
            "凯伦的职责是确保这些墓碑永不风化。他检查冷却液的流速，监测数据冗余阵列的完整性，用细腻的刷子扫去控制台上一夜积攒的、无处不在的微尘。"
            "这个地方是寂静的。唯一的声响是他自己的心跳，是循环系统的低沉嗡鸣，以及偶尔因热胀冷缩而发出的金属呻吟。"
            "但这寂静是一种假象。在凯伦的脑海深处，在他的神经与档案库主机接口的地方，始终回响着一个文明的喧嚣。"
            "他可以随时调取任何一段生命记录，戴上神经共感头环，成为一名星际战舰的飞行员，体验曲率航行时空间扭曲的眩晕；"
            "或者成为一名新巴比伦的诗人，感受在霓虹雨中写下第一句诗时的心潮澎湃；"
            "或者成为一个初为人母的母亲，怀抱新生儿时那无法言喻的、混杂着喜悦与恐惧的爱。"
            "他体验过上百万种人生，却从未拥有过自己的人生。他是记忆的看守者，是历史的活体容器，一个被困在人类文明最终博物馆里的幽灵。"
            "今天，有些事情不一样了。在他进行例行的数据完整性扫描时，一个异常的标记出现在主控台的息屏上。一个从未见过的文件索引，闪烁着不祥的红色。"
            "它的标识符很奇怪，不是标准的十二位编码，而是一串零。零点零点零。一个不存在的地址，一个逻辑上的悖论。"
            "根据记录，它指向的是“前殖民时代”的数据区块，那是一个理论上应该为空的区域。人类的到来就是历史的开始，在此之前，只有沉默的岩石和无机物。"
            "一股混合着恐惧和无法抑制的好奇的情绪攫住了凯LEN。这个异常信号不像是数据损坏，它的结构太完整了，像是一个精心构建的、却使用了完全不同语言写成的文件。"
            "它的能量特征也与档案库中任何人类记忆印记都不同，它更像……更像一次地质事件，一次持续了数百万年的、缓慢的呼吸。"
            "他站在这串闪烁的零面前，站了很久。档案库的协议明确禁止他访问任何未经验证的、可能造成系统污染的异常数据。"
            "他是最后的防线，他的理智是保护这数万亿灵魂的最后一道防火墙。但他已经独自一人太久了。"
            "这无尽的孤独，比任何已知的物理定律都更加沉重。这个异常，是这颗星球在他漫长得近乎永恒的监禁中，第一次对他低语。"
            "他做出了决定。他走向神经共感舱，那是一个光滑的、白色的卵形仪器。他躺了进去，冰冷的凝胶自动注入他脊柱旁的接口。"
            "白色的机械臂将布满传感器的头环轻轻扣在他的头上。通常，他会说出一个名字，一个日期，一个地点，来开始一段旅程。但今天，他只是在脑中默念着那个地址。"
            "零点零点零。世界在他眼前消失了。没有预想中的感官冲击，没有作为另一个人醒来的熟悉体验。这一次，他没有成为任何人。"
            "他成为了……一切。他的意识被无限拉伸，融入到岩石的晶格中，感受着亿万年地质压力下的缓慢形变。"
            "他能感觉到脚下数千公里深处地核的液态金属在涌动，那是一个行星尺度的、慵懒的心跳。他的皮肤是广阔的、被酸雨侵蚀的高原，他的血管是蜿蜒的、携带者矿物盐分的地下河。"
            "时间失去了意义，一千年和一秒钟没有区别。然后，他感觉到了“到来”。那不是一艘船，不是一个舰队。那是天空被撕开的一道伤口。"
            "一道不属于这个世界的光，灼烧着古老的大气层。他能感觉到整个星球意识的震动，一种原始的、不解的惊奇。"
            "有什么东西，一些快速、脆弱、嘈杂的生命，像病毒一样附着在了他的“皮肤”上。他从星球的视角体验了自己祖先的登陆。"
            "那些被称为“先驱者”的人类，在他看来，是一群无法理解的生物。他们移动得太快，生命周期短得像一道闪电。"
            "他们建造的城市，那些直插云霄的金属尖塔，对于行星意识来说，是插入肌体深处的、冰冷的钉子。"
            "他们从大地中抽取“血液”，向大气中排放“毒素”，他们的存在本身就是一种持续的、高烧般的不适。行星试图沟通。"
            "它通过磁场的变化，通过风的模式，通过地震的频率，发出信息。但这些快速的生物无法理解。"
            "他们将这些警告视为自然灾害，用更强大的技术来对抗，掘入得更深，排放得更多。"
            "最终，在持续了数个世纪的痛苦之后，行星的免疫系统被激活了。凯伦感受到了那个决定的形成。"
            "那不是一个恶意的想法，而是一种深刻的、本能的自我保护。就像身体会结疤来保护伤口一样，星球决定用自己最本质的东西——时间和物质——来隔离这场感染。"
            "时序晶体诞生了。它不是一种疾病，而是一种疗愈。"
            "一个巨大的、缓慢的、遍及全球的晶化过程，旨在将所有外来物质，所有不和谐的化学反应，全部封印、分解，最终让世界恢复到它最初的、纯净的、和谐的平衡态。"
            "对于人类来说，这是末日。对于这颗星球来说，这是康复的开始。凯伦的意识被强行从共感中弹出。"
            "警报。刺耳的红色警报灯在他苍白的脸上投下脉动的光影。他在共感舱中剧烈地喘息，冷汗浸湿了内衬。"
            "控制台的显示屏上，代表档案库结构的立体图正在闪烁。一个巨大的晶体结构，正从下方，从他脚下深处，向上生长，已经触及了档案库的最底层外壳。压力读数正在飙升。"
            "档案库正在被这颗星球的“疤痕组织”慢慢挤压。他明白了。一切都明白了。他的文明不是光荣的受害者，而是一个被星球免疫系统清除的致命病毒。"
            "而他，以及他守护的这个金属坟墓，是病毒最后的残余。他冲出共感舱，跌跌撞撞地跑到主控台前。能源读数正在不稳定地波动。"
            "支撑着数万亿记忆的服务器矩阵，有几个区块已经因为结构压力而离线。那些生命印记，那些诗歌、战争、爱情和发现，正在像被风吹散的沙子一样，永远消失。"
            "他必须做出选择。他可以利用档案库剩余的全部能源，启动最高级别的结构力场，或许能为这个文明的坟墓再争取几十年，甚至一个世纪的苟延残喘。"
            "然后呢？在绝对的孤独中，等待着最后的熄灭。或者……他再次连接上神经共感头环，这一次没有进入共感舱，就站在控制台前。他再次潜入那片浩瀚的、属于星球的意识海洋。"
            "他不再是一个旁观者，他是一个寻求者。他带着一个问题回到了那个意识中：如何沟通？行星意识感觉到了他的意图。这一次，它没有展现历史，而是展现了一种模式。"
            "一种极其复杂的、由引力波、电磁频率和亚原子粒子自旋构成的谐振模式。那不是一种武器，也不是一种密码。那是这颗星球的名字。一个只能用物理定律本身来呼唤的名字。"
            "凯伦的眼中闪烁着疯狂的光芒。这是一个赌上一切的计划，一个没有任何理论支持的、源于一段异星梦境的疯狂想法。他没有丝毫犹豫。他的手指在控制台上化作了一片残影。"
            "他绕过所有的安全协议，将档案库主反应堆中剩余的所有能量，全部、毫无保留地导向了深空通讯阵列。那本来是用于向宇宙深处发送求救信号的设备，但它已经沉默了几个世纪。"
            "现在，它将成为凯伦的乐器。他将那个复杂的谐振模式作为载波，将整个最终档案库的数据——全部的数据——作为信息，加载了上去。他没有发送求救信号，也没有发送投降的请求。"
            "他发送了一份礼物。一份道歉。一份忏悔。他将人类文明的一切都发送了出去。"
            "从第一声啼哭到最后的叹息，从穴居时代的壁画到星际联邦的宪章，从最无私的奉献到最残忍的暴行，从一个孩子画下的歪歪扭扭的太阳，到描述宇宙最终热寂的方程式。"
            "所有的一切，好的，坏的，美的，丑的，全都被编码进了那束以星球之名调制的信号中。这是一场豪赌。"
            "他赌的是，任何一个能够孕育出意识的系统，无论其形态如何，最终都能理解一件事：存在的价值。能量输出达到了顶峰，然后归于虚无。"
            "档案库的灯光彻底熄灭，陷入了绝对的黑暗与死寂。凯伦站在黑暗中，唯一能听见的，是他自己擂鼓般的心跳。"
            "然后，透过主观测窗，一缕光照了进来。那不是之前那种冰冷的、紫罗兰色的光。那是一种温暖的、如同黎明般的金色光芒。"
            "覆盖着整个世界的晶体不再扩张，那令人窒息的压力从档案库的外壳上消失了。凯伦看到，外面的晶体世界正在发生改变。它们没有后退，而是在重组。"
            "巨大的晶体结构开始以一种有机的方式生长，它们分解了档案库最外层的合金，将那些金属原子融入自身，构建出一种前所未见的、半金属半晶体的、闪烁着内部光芒的全新结构。"
            "它们像是在用人类文明的残骸，为这个世界编织新的神经和血管。就在那时，凯伦感觉到，在他的脑海里，出现了一个新的存在。"
            "一个广阔、古老、沉静如深海的意识，轻轻地触碰了他的思想。它没有语言，没有图像，但凯伦理解了它。它在说，礼物收到了。它在说，道歉接受了。"
            "它在说，现在，让我们一起，创造一些新的东西吧。凯伦闭上了眼睛。他不再是凯伦，最后的档案保管员。"
            "他的自我意识像一滴水融入了大海，他的孤独在瞬间被一个星球的感知所填满。他成为了一个"
        ]

        sampling_params = SamplingParams(temperature=0, top_k=1, max_tokens=300)

        print_output(llm, prompts_prefill_more_than_2_full_blk, sampling_params, "first")
        print_output(llm, prompts_prefill_more_than_2_full_blk, sampling_params, "second")

if __name__ == "__main__":
    main()
