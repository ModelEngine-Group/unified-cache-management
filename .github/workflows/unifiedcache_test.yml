name: 'ucm-lint-and-unittest'

on:
  push:
    branches:
      - 'main'
      - 'dev*'
      - '*release'
  pull_request:
    branches:
      - 'main'
      - 'dev*'
      - '*release'

jobs:
  gpu-test:
    uses: ./.github/workflows/e2e_test.yml

  call-lint:
    uses: ./.github/workflows/pre-commit.yml

  unit-test:
    needs: call-lint
    name: Run Unittests
    runs-on: ubuntu-latest
    steps:
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf "/usr/local/share/boost"
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          docker system prune -af
          df -h

      - name: Checkout unified-cache-management repo
        uses: actions/checkout@v4

      - name: Run unit test inside vLLM container
        run: |
          docker run --rm \
            -e VLLM_USE_PRECOMPILED=1 \
            -e PLATFORM=cuda \
            -v ${{ github.workspace }}:/workspace/unified-cache-management \
            -w /workspace/unified-cache-management \
            --entrypoint /bin/bash \
            vllm/vllm-openai:v0.9.2 \
            -c "
              set -euo pipefail
              pip install -v -e . --no-build-isolation
              cd \$(pip show vllm | grep Location | awk '{print \$2}') &&
              git apply /workspace/unified-cache-management/ucm/integration/vllm/patch/0.9.2/vllm-adapt.patch
              cd /workspace/unified-cache-management
              python3 -m unittest discover -s test
            "
